<!DOCTYPE html>
<html lang="en">
  <head>
    <title>A small introduction to three.js webgl [1]</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel="stylesheet" href="css/basic.css">
  </head>
  <body>
    <div id="info"><a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> Q1: a rotating WebGL cube</div>
    <canvas id="webglcanvas" style="border: none;background-color:#000000"
	    width="800" height="600"></canvas>

    <!-- <script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.min.js"></script> -->
    
    <script type="importmap">
      {
	  "imports": {
		"three": "./three.module.js",
		"three/addons/controls/": "./examples/jsm/controls/"
	  }
      }
    </script>
  
    <script type="module">
      import * as THREE from 'three';

	  var imagesFolder = "../../images/tp3_info804/";
      
      var renderer = null; 
      var scene    = null;
      var camera   = null;
	  var cameraAngle = 60;
	  var earth    = null;
	  var moon     = null;
	  var sun      = null;
	  var earthGroup = null;
	  var moonGroup  = null;
	  var earthSystem= null;
      var curTime  = Date.now();
      var canvas = document.getElementById("webglcanvas");

	  var earthGroup = new THREE.Group();
	  var moonGroup  = new THREE.Group();

      // Checks that your browser supports WebGL. 
      if ( ! ( window.WebGLRenderingContext
	       && ( canvas.getContext('webgl')
		    || canvas.getContext('experimental-webgl')) ) )
	  console.log( "WebGL not supported on your browser." );
      
      init();
      run();
      
      // This function is called whenever the document is loaded
      function init() {
	  
		// Create the Three.js renderer and attach it to our canvas
		renderer = new THREE.WebGLRenderer( { canvas: canvas,
							antialias: true } );
		// Set the viewport size
		//renderer.setSize( canvas.width, canvas.height );
		renderer.setSize(window.innerWidth, window.innerHeight);
		// Create a new Three.js scene
		scene = new THREE.Scene();
		// Add  a camera so we can view the scene
		camera = new THREE.PerspectiveCamera( 45, /*canvas.width / canvas.height*/ window.innerWidth / window.innerHeight,
							1, 4000 );

		// TERRE
		// Create a texture-mapped sphere and add it to the scene
		// First, create the texture map
		var mapUrl = imagesFolder + "earth_atmos_2048.jpg";
		var map    = new THREE.TextureLoader().load( mapUrl );
		// Now, create a Phong material; pass in the map
		var material = new THREE.MeshPhongMaterial({ map: map, specular: new THREE.Color("white") });
		// Create the sphere geometry
		var geometry = new THREE.SphereGeometry();//THREE.BoxGeometry(2, 2, 2);
		// And put the geometry and material together into a mesh
		earth = new THREE.Mesh(geometry, material);
		// Move the mesh back from the camera and tilt it toward the viewer
		earth.position.z = -8;
		earth.rotation.x = Math.PI / 5;
		earth.rotation.y = Math.PI / 5;	
		// Finally, add the mesh to our scene
		earthGroup.add( earth )
		scene.add( earthGroup );

		// LUNE
		var moonMapUrl = imagesFolder + "moon_1024.jpg";
		var moonMap = new THREE.TextureLoader().load( moonMapUrl );
		var moonMaterial = new THREE.MeshPhongMaterial({ map: moonMap, specular: new THREE.Color("gray") });
		var moonGeometry = new THREE.SphereGeometry(0.5);
		moon = new THREE.Mesh(moonGeometry, moonMaterial);
		moon.position.z = -8;
		moon.position.x = -2;
		moon.position.y = 1.5;
		moon.rotation.x = Math.PI / 5;
		moon.rotation.y = Math.PI / 5;	
		moonGroup.add( moon )
		earthGroup.add( moonGroup )
		//scene.add( moonGroup );

		// SOLEIL
		// Add a white point light, which lights at infinite distance and without decay
		// with the distance.
		var sunGeometry = new THREE.SphereGeometry(1.6);
		var sunMaterial = new THREE.MeshBasicMaterial({ color: new THREE.Color("yellow") });
		sun = new THREE.Mesh(sunGeometry, sunMaterial);
		sun.position.z = -8;
		sun.position.y = 1;
		sun.position.x = 5;
		scene.add( sun );

		var light = new THREE.PointLight( 0xffffff, 2.5, 0.0, 0.0 );
		light.position.set( 50, 50, 50 );
		scene.add( light );
      }
      
      // This function is called regularly to update the canvas webgl.
      function run() {
		// Ask to call again run 
		requestAnimationFrame( run );
		
		// Render the scene
		render();
		
		// Calls the animate function if objects or camera should move
		animate();
      }
      
      // This function is called regularly to take care of the rendering.
      function render() {
		// Render the scene
		renderer.render( scene, camera );
      }
      
      // This function is called regularly to update objects.
      function animate() {
		// Computes how time has changed since last display
		var now       = Date.now();
		var deltaTime = now - curTime;
		curTime       = now;
		var fracTime  = deltaTime / 1000; // in seconds
		// Now we can move objects, camera, etc.

		var angle = fracTime * Math.PI * 2;
		// Notez que l'axe y est l'axe "vertical" usuellement.
		earthGroup.rotation.y += angle / 365; // la terre tourne en 365 jours
		earth.rotation.y      += angle; // et en un jour sur elle-même
		moonGroup.rotation.y  += angle / 28; // la lune tourne en 28 jours autour de la terre
		moon.rotation.y       += angle /28; // et en 28 jours aussi sur elle-même pour faire face à la terre

		// caméra
		//camera.lookAt( earth.matrixWorld.getPosition() );
		// Avec un grand demi-axe de 5 et un petit demi-axe de 3
		// camera.position.x = 5 * Math.cos( cameraAngle );
		// camera.position.y = 3 * Math.sin( cameraAngle );
      }
      
    </script>

  </body>
</html>